"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4792],{3072:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(65521),i=s(76427);let a=(0,r.v)((e,t)=>({settings:i.a$,isLoading:!1,error:null,setSettings:t=>{e({settings:(0,i.h_)(t)})},setLoading:t=>e({isLoading:t}),setError:t=>e({error:t}),getSetting:e=>{let{settings:s}=t();return s[e]},updateSetting:(t,s)=>{e(e=>({settings:{...e.settings,[t]:s}}))}}))},7034:(e,t,s)=>{s.d(t,{S:()=>n,XQ:()=>a});var r=s(5604);let i=(0,s(13853).A)("chess-perks");r.Ik({type:r.Yj(),game_id:r.Yj(),client_id:r.Yj(),data:r.g1(r.Yj(),r.bz()),created_at:r.ai(),updated_at:r.ai()}),r.Ik({type:r.Yj(),data:r.g1(r.Yj(),r.bz()).optional()});class a{log(e){this._logs.push(e),i("\uD83D\uDCDD [".concat(this.type.toUpperCase(),"] ").concat(e))}constructor(e,t){this._logs=[],this.type=e,this.side=t,i("\uD83C\uDFAF [PERK] Created ".concat(e," perk on ").concat(t," side"))}}class n{registerPerk(e){this.perks.set(e.type,e),i("✅ [PERKS] Registered perk: ".concat(e.type))}getPerk(e){return this.perks.get(e)}getAllPerks(){return Array.from(this.perks.values())}async applyPerk(e,t,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=this.perks.get(e);if(!a)throw Error("Perk ".concat(e," not registered"));i("\uD83D\uDE80 [PERKS] Applying perk ".concat(e," in game ").concat(t," by client ").concat(s));let n={type:e,game_id:t,client_id:s,data:r,created_at:Date.now(),updated_at:Date.now()};this.applied.push(n),await a.handlePerk(t,s,r,this),i("✅ [PERKS] Successfully applied perk ".concat(e))}async handleMoveBefore(e,t,s,r){let a=new Map;for(let n of(i("\uD83C\uDFAF [PERKS] Processing BEFORE move ".concat(s.from,"-").concat(s.to," through ").concat(this.perks.size," perks")),this.perks.values())){let o=await n.handleMoveBefore(e,t,s,r,this);if(null===o)return i("❌ [PERKS] Move cancelled by perk ".concat(n.type," in BEFORE phase")),null;o&&(a.set(n.type,o),i("\uD83D\uDCDD [PERKS] Perk ".concat(n.type," stored before data:"),o))}return a}async handleMoveAfter(e,t,s,r,a){let n=r;for(let r of(i("\uD83C\uDFAF [PERKS] Processing AFTER move ".concat(s.from,"-").concat(s.to," through ").concat(this.perks.size," perks")),this.perks.values())){let o=a.get(r.type)||null,c=await r.handleMoveAfter(e,t,s,n,o,this);if(null===c)return i("❌ [PERKS] Move rejected by perk ".concat(r.type," in AFTER phase")),null;c!==n&&(i("\uD83D\uDD04 [PERKS] Perk ".concat(r.type," modified board position in AFTER phase")),n=c)}return n}async handleMove(e,t,s,r){i("\uD83C\uDFAF [PERKS] Processing move ".concat(s.from,"-").concat(s.to," using legacy handleMove (will use two-phase internally)"));let a=await this.handleMoveBefore(e,t,s,r);return null===a?null:await this.handleMoveAfter(e,t,s,r,a)}async getApplied(e,t){let s=this.applied.filter(s=>s.type===e&&s.game_id===t);return i("\uD83D\uDCCA [PERKS] Found ".concat(s.length," applied ").concat(e," perks for game ").concat(t)),s}async getAllApplied(e){let t=this.applied.filter(t=>t.game_id===e);return i("\uD83D\uDCCA [PERKS] Found ".concat(t.length," total applied perks for game ").concat(e)),t}clearApplied(){this.applied=[],i("\uD83E\uDDF9 [PERKS] Cleared all applied perks")}getAllLogs(){let e=[];for(let t of this.perks.values())e.push(...t._logs);return e}clearAllLogs(){for(let e of this.perks.values())e._logs=[];i("\uD83E\uDDF9 [PERKS] Cleared all perk logs")}constructor(e){this.perks=new Map,this.applied=[],this.side=e,i("\uD83C\uDFAE [PERKS] Created ChessPerks manager on ".concat(e," side"))}}},23806:(e,t,s)=>{s.d(t,{e:()=>c,g:()=>d});var r=s(97418),i=s(13853),a=s(51368),n=s(7034);let o=(0,i.A)("client");var c=function(e){return e[e.Anonymous=0]="Anonymous",e[e.Player=1]="Player",e[e.Voter=2]="Voter",e}({});class d{get chess(){return this._chess}set chess(e){this._chess=e}get perks(){return this._perks}get turn(){return this._chess.turn}set turn(e){this._chess.turn=e}get fen(){return this._chess.fen}set fen(e){this._chess.fen=e}get clientId(){return this._clientId}set clientId(e){this._clientId=e}get userId(){return this._userId}set userId(e){this._userId=e}get gameId(){return this._gameId}set gameId(e){this._gameId=e}get joinId(){return this._joinId}set joinId(e){this._joinId=e}get side(){return this._side}set side(e){this._side=e}get role(){return this._role}set role(e){this._role=e}get status(){return this._status}set status(e){this._status=e}get updatedAt(){return this._updatedAt}set updatedAt(e){this._updatedAt=e}get createdAt(){return this._createdAt}set createdAt(e){this._createdAt=e}_error(e,t){o("error",e,t)}syncCreate(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(o("syncCreate",e,t),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};void 0!==e&&(this.side=e),void 0!==t&&(this.role=t),this.status="await",this.updatedAt=Date.now(),this.createdAt=this.updatedAt,this.gameId=(0,a.A)(),this.joinId=(0,a.A)();let s={operation:"create",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,updatedAt:this.updatedAt,createdAt:this.createdAt};this._create(s).then(e=>{e.error?(this.status="error",o("syncCreate:error",e),this._error(s,e)):e.data&&(e.data.gameId!=this.gameId&&this._error(s,{...e,error:"gameId!=this.gameId"}),e.data.joinId!=this.joinId&&this._error(s,{...e,error:"joinId!=this.joinId"}),e.data.side!=this.side&&this._error(s,{...e,error:"side!=this.side"}),e.data.role!=this.role&&this._error(s,{...e,error:"role!=this.role"}),e.data.status!=this.status&&this._error(s,{...e,error:"status!=this.status"}),this.applySyncResponse(e.data))}).catch(e=>{this.status="error",o("syncCreate:catch",e),this._error(s,{...e,recommend:"retry"})});let r={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("syncCreate:response",r),r}async asyncCreate(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(o("asyncCreate","this.userId",this.userId),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};e&&(this.turn=e),this.status="await",this.updatedAt=Date.now(),this.createdAt=this.updatedAt;let t={operation:"create",clientId:this.clientId,userId:this.userId,side:this.side,updatedAt:this.updatedAt,createdAt:this.createdAt},s=await this._create(t);s.error?(this.status="error",o("asyncCreate:error",s),this._error(t,s)):s.data&&(s.data.gameId&&(this.gameId=s.data.gameId),s.data.status&&(this.status=s.data.status),this.applySyncResponse(s.data));let r={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,fen:this.fen,status:this.status,updatedAt:this.updatedAt=Date.now(),createdAt:this.createdAt=this.updatedAt}};return o("asyncCreate:response",r),r}async _create(e){if(o("_create:fake",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};let t={data:{clientId:this.clientId,gameId:this.gameId||(0,a.A)(),fen:this.fen,status:this.status,updatedAt:e.updatedAt,createdAt:e.createdAt}};return o("_create:fake:result",t),t}syncJoin(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(o("syncJoin",e,t),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(this.joinId)return{error:"!!this.joinId"};if(void 0!==this.side)return{error:"side!=undefined"};if("await"!==this.status)return{error:"status!=await"};this.joinId=(0,a.A)(),this.side=e,this.role=t,this.updatedAt=Date.now();let s={operation:"join",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,updatedAt:this.updatedAt,createdAt:this.createdAt};this._join(s).then(e=>{e.error?(this.status="error",o("syncJoin:error",e),this._error(s,e)):e.data&&(e.data.joinId&&(this.joinId=e.data.joinId),e.data.side!=this.side&&this._error(s,{...e,error:"side!=this.side"}),e.data.role!=this.role&&this._error(s,{...e,error:"role!=this.role"}),e.data.status!=this.status&&this._error(s,{...e,error:"status!=this.status"}),this.applySyncResponse(e.data))}).catch(e=>{this.status="error",o("syncJoin:catch",e),this._error(s,{...e,recommend:"retry"})});let r={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("syncJoin:response",r),r}async asyncJoin(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(o("asyncJoin",e,t),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};this.side=e,this.role=t,this.status="await",this.updatedAt=Date.now(),this.createdAt=this.updatedAt,this.joinId=(0,a.A)();let s={operation:"join",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,updatedAt:this.updatedAt,createdAt:this.createdAt},r=await this._join(s);return r.error?(this.status="error",o("asyncJoin:error",r),this._error(s,r),{error:r.error,recommend:r.recommend}):r.data?(o("asyncJoin:data",r),r.data.gameId!=this.gameId&&this._error(s,{...r,error:"gameId!=this.gameId"}),r.data.joinId!=this.joinId&&this._error(s,{...r,error:"joinId!=this.joinId"}),this.applySyncResponse(r.data),{data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}}):{error:"unknown response"}}async _join(e){if(o("_join:fake",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(void 0==e.side)return{error:"!side"};let t={data:{clientId:this.clientId,gameId:this.gameId,joinId:e.joinId||(0,a.A)(),side:e.side,role:e.role,fen:this.fen,status:this.status,updatedAt:e.updatedAt,createdAt:e.createdAt}};return o("_join:fake:result",t),t}syncLeave(e){if(o("syncLeave",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(!this.joinId)return{error:"!this.joinId"};if(0===this.side)return{error:"side === 0 (Anonymous cannot leave/surrender)"};if(0==this.role)return{error:"role==Anonymous (Anonymous cannot leave/surrender)"};if("await"!==this.status&&"ready"!==this.status&&"continue"!==this.status)return{error:"status(".concat(this.status,") not await|ready|continue")};let t=1===this.side?"white_surrender":"black_surrender";this.status=t,this.updatedAt=Date.now();let s={operation:"leave",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:0,role:0,updatedAt:this.updatedAt,createdAt:this.createdAt};this._leave(s).then(e=>{e.error?(o("syncLeave:error",e),this._error(s,e)):e.data&&(this.applySyncResponse(e.data),o("syncLeave:success",e.data))}).catch(e=>{o("syncLeave:catch",e),this._error(s,{...e,recommend:"retry"})}),this.side=0,this.role=0,this.joinId=void 0;let r={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("syncLeave:response",r),r}async asyncLeave(e){if(o("asyncLeave",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(0===this.side)return{error:"side === 0 (Anonymous cannot leave/surrender)"};if(0==this.role)return{error:"role==Anonymous (Anonymous cannot leave/surrender)"};if("await"!==this.status&&"ready"!==this.status&&"continue"!==this.status)return{error:"status(".concat(this.status,") not await|ready|continue")};let t=1===e?"white_surrender":"black_surrender";this.status=t,this.updatedAt=Date.now();let s={operation:"leave",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:0,role:0,updatedAt:this.updatedAt,createdAt:this.createdAt},r=await this._leave(s);r.error?(o("asyncLeave:error",r),this._error(s,r)):r.data?(o("asyncLeave:success",r.data),this.applySyncResponse(r.data)):(this.side=0,this.role=0,this.joinId=void 0);let i={error:r.error,data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("asyncLeave:response",i),i}async _leave(e){if(o("_leave:fake",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(void 0==e.side)return{error:"!side"};if(void 0==e.role)return{error:"!role"};let t={data:{clientId:this.clientId,gameId:this.gameId,joinId:e.joinId||(0,a.A)(),side:e.side,role:e.role,fen:this.fen,status:this.status,updatedAt:e.updatedAt,createdAt:e.createdAt}};return o("_leave:fake:result",t),t}syncMove(e){if(o("syncMove",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(!this.joinId)return{error:"!this.joinId"};if(!this.side)return{error:"!this.side"};if(!this.role)return{error:"!this.role"};if("ready"!==this.status&&"continue"!==this.status)return{error:"status(".concat(this.status,")!=ready|continue")};if(this.chess.isGameOver){let e=this.chess.status;return o("syncMove: Game already over:",e),this.status=e,this.updatedAt=Date.now(),{error:"Game is already over: ".concat(e)}}let t=this.chess.move(e);if(t.error)return o("syncMove:invalid move:",t.error),{error:t.error};this.updatedAt=Date.now(),this._pendingMove=e,this._pendingFen=this.fen,this._pendingMoveTimeout&&clearTimeout(this._pendingMoveTimeout),this._pendingMoveTimeout=setTimeout(()=>{this._pendingMove=null,this._pendingFen=null,this._pendingMoveTimeout=null},this.PENDING_MOVE_TIMEOUT),this.status=this.chess.status,o("syncMove:success, new status:",this.status,"new fen:",this.fen),this._perks.handleMove(this.gameId,this.clientId,e,this.fen).then(e=>{e&&e!==this.fen&&(o("syncMove:perks modified FEN:",e),this.fen=e)}).catch(e=>{o("syncMove:perks error:",e)});let s={operation:"move",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,move:e,updatedAt:this.updatedAt,createdAt:this.createdAt};this._move(s).then(e=>{e.error?(o("syncMove:error",e),this._clearPendingState(),this._error(s,e)):e.data&&(o("syncMove:success",e.data),this._clearPendingState(),this.applySyncResponse(e.data))}).catch(e=>{o("syncMove:error",e),this._clearPendingState(),this._error(s,{...e,recommend:"retry"})});let r={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("syncMove:response",r),r}async asyncMove(e){if(o("asyncMove",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(!this.joinId)return{error:"!this.joinId"};if(!this.side)return{error:"!this.side"};if(!this.role)return{error:"!this.role client role not set"};if("ready"!==this.status&&"continue"!==this.status)return{error:"status(".concat(this.status,")!=ready|continue")};if(this.chess.isGameOver){let e=this.chess.status;return o("asyncMove: Game already over:",e),this.status=e,this.updatedAt=Date.now(),{error:"Game is already over: ".concat(e)}}let t=this.chess.move(e);if(t.error)return o("syncMove:invalid move:",t.error),{error:t.error};this.updatedAt=Date.now(),this.status=this.chess.status,o("asyncMove:success, new status:",this.status,"new fen:",this.fen);let s=await this._perks.handleMove(this.gameId,this.clientId,e,this.fen);s&&s!==this.fen&&(o("asyncMove:perks modified FEN:",s),this.fen=s);let r={operation:"move",clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,move:e,updatedAt:this.updatedAt,createdAt:this.createdAt},i=await this._move(r);i.error?(o("asyncMove:error",i),this._error(r,i)):i.data&&(o("asyncMove:success",i.data),this.applySyncResponse(i.data));let a={error:i.error,data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("asyncMove:response",a),a}async _move(e){if(o("_move:fake",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(!e.side)return{error:"!side"};if(!e.role)return{error:"!role"};if(!e.move)return{error:"!move"};let t={data:{clientId:this.clientId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("_move:fake:result",t),t}syncPerk(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(o("syncPerk",{type:e,data:t}),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};let s={operation:"perk",clientId:this.clientId,userId:this.userId,gameId:this.gameId,perk:{type:e,data:t},updatedAt:Date.now(),createdAt:this.createdAt};this._perks.applyPerk(e,this.gameId,this.clientId,t).catch(e=>{o("syncPerk:local error",e)}),this._perk(s).then(e=>{e.error?o("syncPerk:error",e):o("syncPerk:success",e.data)}).catch(e=>{o("syncPerk:error",e)});let r={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("syncPerk:response",r),r}async asyncPerk(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(o("asyncPerk",{type:e,data:t}),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};let s={operation:"perk",clientId:this.clientId,userId:this.userId,gameId:this.gameId,perk:{type:e,data:t},updatedAt:Date.now(),createdAt:this.createdAt};try{await this._perks.applyPerk(e,this.gameId,this.clientId,t)}catch(e){return o("asyncPerk:local error",e),{error:"Local perk application failed: ".concat(e)}}let r=await this._perk(s);if(r.error)return o("asyncPerk:error",r),{error:r.error};o("asyncPerk:success",r.data);let i={data:{clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("asyncPerk:response",i),i}async _perk(e){if(o("_perk:fake",e),!this.clientId)return{error:"!this.clientId"};if(!this.userId)return{error:"!this.userId"};if(!this.gameId)return{error:"!this.gameId"};if(!e.perk)return{error:"!perk"};let t={data:{clientId:this.clientId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt}};return o("_perk:fake:result",t),t}async asyncSync(){if(o("asyncSync initiated"),!this.clientId)return{error:"!this.clientId for sync"};if(!this.userId)return{error:"!this.userId for sync"};if(!this.gameId)return{error:"!this.gameId for sync"};let e={operation:"sync",clientId:this.clientId,userId:this.userId,gameId:this.gameId,updatedAt:Date.now(),createdAt:this.createdAt};try{let t=await this._sync(e);if(o("asyncSync received server response:",t),t.error)return this.status="error",this._error(e,t),{error:t.error,recommend:t.recommend};if(!t.data)return o("asyncSync received unknown response format"),{error:"Unknown response from server during sync"};{this.applySyncResponse(t.data);let e={clientId:this.clientId,userId:this.userId,gameId:this.gameId,joinId:this.joinId,side:this.side,role:this.role,fen:this.fen,status:this.status,updatedAt:this.updatedAt,createdAt:this.createdAt};return o("asyncSync successful, new client state:",e),{data:e}}}catch(t){return o("asyncSync error calling _sync:",t),this.status="error",this._error(e,{error:t.message||"Sync request failed"}),{error:t.message||"Sync request failed"}}}applySyncResponse(e){var t,s;if(o("Applying sync response:",e),!e)return void o("Error: applySyncResponse called with null or undefined data.");this.gameId&&e.gameId?this.gameId=e.gameId:e.gameId!==this.gameId&&o("Warning: Sync response gameId ".concat(e.gameId," differs from client gameId ").concat(this.gameId)),this.clientId&&e.clientId?this.clientId=e.clientId:e.clientId!==this.clientId&&o("Warning: Sync response clientId ".concat(e.clientId," differs from client clientId ").concat(this.clientId)),this._pendingMove&&this._pendingFen?e.fen===this._pendingFen&&this._clearPendingState():this.fen!==e.fen?(o("Sync updating FEN from ".concat(this.fen," to ").concat(e.fen)),this.fen=e.fen):o("Sync FEN matches, no update."),this.status=e.status,this.side=null!=(t=e.side)?t:0,this.role=null!=(s=e.role)?s:0,this.joinId=e.joinId,this.updatedAt=e.updatedAt,o("Client state after applySyncResponse: side=".concat(this.side,", role=").concat(this.role,", joinId=").concat(this.joinId,", status=").concat(this.status,", fen=").concat(this.fen))}_clearPendingState(){this._pendingMoveTimeout&&(clearTimeout(this._pendingMoveTimeout),this._pendingMoveTimeout=null),this._pendingMove=null,this._pendingFen=null}static positionToCoordinates(e){if("string"!=typeof e||2!==e.length)throw Error("ChessClient:positionToCoordinates:invalid");let t=e.charAt(0).toLowerCase(),s=e.charAt(1);if(t<"a"||t>"h"||s<"1"||s>"8")throw Error("ChessClient:positionToCoordinates:invalid");return{x:t.charCodeAt(0)-97,y:8-parseInt(s)}}constructor(e){this._pendingMove=null,this._pendingFen=null,this._pendingMoveTimeout=null,this.PENDING_MOVE_TIMEOUT=1e4,this._role=0,this._status="unknown",this._updatedAt=Date.now(),this._createdAt=Date.now(),this._chess=new r.d,this._perks=new n.S("client")}}},59380:(e,t,s)=>{s.d(t,{G7:()=>d,Qg:()=>c});var r=s(12115),i=s(259),a=s(76427),n=s(3072);let o=(0,s(13853).A)("user-settings");function c(){let{settings:e,isLoading:t,error:s,getSetting:r,updateSetting:i}=(0,n.Z)();return{settings:e,loading:t,error:s,getSetting:r,updateSetting:i}}function d(e){o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Hook called with userIds:",e);let t=0===e.length;o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Skip condition:",t);let s={table:"badma_settings",where:{user_id:{_in:e}},returning:["id","key","value","user_id"]};o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Subscription config:",s);let{data:n,loading:c,error:d}=(0,i.useQuery)(s,{skip:t});return o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Raw query result:",{data:n,loading:c,error:d,userIds:e}),n&&(o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Data type:",typeof n),o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Data is array:",Array.isArray(n)),o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Data length:",null==n?void 0:n.length)),{settingsMap:(0,r.useMemo)(()=>{o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Processing data for users:",e),o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Raw data from query:",n);let t={};if(e.forEach(e=>{t[e]=(0,a.h_)([]),o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Initialized defaults for user:",e,t[e])}),!n||!Array.isArray(n))return o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] No data or not array, returning defaults"),t;o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Data is valid array with length:",n.length);let s={};return n.forEach((e,t)=>{o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Processing setting",t,":",e),s[e.user_id]||(s[e.user_id]=[]),s[e.user_id].push(e)}),o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Settings grouped by user:",s),Object.entries(s).forEach(e=>{let[s,r]=e;o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Processing settings for user:",s,r);let i=r.map(e=>({id:e.id,key:e.key,value:e.value}));o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Settings array for user:",s,i);let n=(0,a.h_)(i);o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Final settings for user:",s,n),t[s]=n}),o("\uD83D\uDD0D [MULTIPLE_USER_SETTINGS] Final result:",t),t},[n,e]),loading:c,error:d}}},64183:(e,t,s)=>{s.d(t,{Ay:()=>c,LK:()=>h,Qy:()=>d});var r=s(95155);s(12115);var i=s(7034),a=s(23806),n=s(97418);let o=(0,s(13853).A)("minefield_perk");function c(e){let t,s,{className:i="",onClick:a,size:n="small"}=e;return"large"===n?(t="w-80 h-96",s="text-xl"):"medium"===n?(t="w-64 h-80",s="text-lg"):(t="w-48 h-64",s="text-md"),(0,r.jsx)("div",{className:"".concat(t," ").concat(i," cursor-pointer"),onClick:a,children:(0,r.jsxs)("div",{className:"w-full h-full bg-gradient-to-br from-red-50 to-red-100 dark:from-red-950 dark:to-red-900 rounded-lg border border-red-200 dark:border-red-800 p-4 flex flex-col items-center justify-center",children:[(0,r.jsx)("div",{children:(0,r.jsxs)("svg",{width:"160",height:"160",viewBox:"0 0 120 120",className:"border border-red-300 dark:border-red-700 rounded-sm",children:[Array.from({length:8},(e,t)=>Array.from({length:8},(e,s)=>{let i=(t+s)%2==0;return(0,r.jsx)("rect",{x:15*s,y:15*t,width:"15",height:"15",fill:i?"#f0f0f0":"#d0d0d0",stroke:"#999",strokeWidth:"0.5"},"".concat(t,"-").concat(s))})),[{x:2,y:3},{x:5,y:2},{x:1,y:6},{x:6,y:4}].map((e,t)=>(0,r.jsxs)("g",{children:[(0,r.jsx)("circle",{cx:15*e.x+7.5,cy:15*e.y+7.5,r:"6",fill:"#ff4444",opacity:"0.3"}),(0,r.jsx)("circle",{cx:15*e.x+7.5,cy:15*e.y+7.5,r:"3",fill:"#cc0000"}),(0,r.jsxs)("g",{stroke:"#cc0000",strokeWidth:"1",opacity:"0.8",children:[(0,r.jsx)("line",{x1:15*e.x+7.5,y1:15*e.y+4.5,x2:15*e.x+7.5,y2:15*e.y+10.5}),(0,r.jsx)("line",{x1:15*e.x+4.5,y1:15*e.y+7.5,x2:15*e.x+10.5,y2:15*e.y+7.5}),(0,r.jsx)("line",{x1:15*e.x+5.5,y1:15*e.y+5.5,x2:15*e.x+9.5,y2:15*e.y+9.5}),(0,r.jsx)("line",{x1:15*e.x+9.5,y1:15*e.y+5.5,x2:15*e.x+5.5,y2:15*e.y+9.5})]})]},t)),(0,r.jsx)("text",{x:"60",y:"10",textAnchor:"middle",fontSize:"8",fill:"#cc0000",fontWeight:"bold",children:"⚠ DANGER ⚠"})]})}),(0,r.jsx)("h3",{className:"".concat(s," font-semibold text-center mt-2"),children:"Минное поле"})]})})}class d extends i.XQ{async handleApply(e,t,s){this.log("Applying minefield perk on client for game ".concat(t));try{await e.asyncPerk("minefield_perk",s||{}),this.log("Successfully applied minefield perk")}catch(e){throw this.log("Failed to apply minefield perk: ".concat(e)),e}}async handlePerk(e,t,s,r){if(this.log("Minefield perk applied on ".concat(this.side," with data: ").concat(JSON.stringify(s))),"server"===this.side){let e=new n.d;e.fen=s._serverFen||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";let t=this.getEmptySquares(e.fen);this.minePositions=this.selectRandomMines(t,4),s.squares=this.minePositions,this.log("Server: Generated mine positions: ".concat(this.minePositions.join(", ")))}else this.minePositions=s.squares||[],this.log("Client: Received mine positions: ".concat(this.minePositions.join(", ")))}async handleMoveBefore(e,t,s,r,i){let a="[BEFORE] Checking move ".concat(s.from,"-").concat(s.to," for mine collision");return(this.log(a),this.minePositions.includes(s.to))?(this.log("[BEFORE] \uD83D\uDCA5 Mine detected at ".concat(s.to,"!")),{hitMine:!0,mineSquare:s.to}):{hitMine:!1}}async handleMoveAfter(e,t,s,r,i,a){if(!(null==i?void 0:i.hitMine))return null;let o=i.mineSquare;this.log("[AFTER] \uD83D\uDCA5 Exploding mine at ".concat(o,", removing piece"));let c=new n.d;c.fen=r,c.remove(o);let d=c.fen;return this.log("[AFTER] Modified FEN: ".concat(d)),d}getEmptySquares(e){let t=new n.d;t.fen=e;let s=[],r=["1","2","3","4","5","6","7","8"];for(let e of["a","b","c","d","e","f","g","h"])for(let i of r){let r=e+i;t.chess.get(r)||s.push(r)}return o("Found ".concat(s.length," empty squares:"),s),s}selectRandomMines(e,t){if(e.length<t)return o("Warning: Only ".concat(e.length," empty squares available, requested ").concat(t," mines")),[...e];let s=[],r=[...e];for(let e=0;e<t;e++){let e=Math.floor(Math.random()*r.length);s.push(r[e]),r.splice(e,1)}return o("Selected ".concat(s.length," random mine positions:"),s),s}getMinePositions(){return[...this.minePositions]}constructor(e){super("minefield_perk",e),this.minePositions=[]}}let h=e=>{var t;let{gameData:s}=e,i=(null==s||null==(t=s.perks)?void 0:t.filter(e=>"minefield_perk"===e.type))||[],n=[];return(i.forEach(e=>{var t;(null==(t=e.data)?void 0:t.squares)&&Array.isArray(e.data.squares)&&n.push(...e.data.squares)}),0===n.length)?null:(0,r.jsx)(r.Fragment,{children:n.map((e,t)=>{try{let s=a.g.positionToCoordinates(e),i=s.x/8*100,n=s.y/8*100,o=1/8*100;return(0,r.jsx)("div",{className:"absolute bg-red-500 opacity-70 pointer-events-none z-10",style:{left:"".concat(i,"%"),top:"".concat(n,"%"),width:"".concat(o,"%"),height:"".concat(o,"%")},title:"Mine at ".concat(e)},"mine-".concat(e,"-").concat(t))}catch(t){return console.warn("Invalid mine square: ".concat(e),t),null}})})}},74001:(e,t,s)=>{s.d(t,{QK:()=>l,vr:()=>c,nO:()=>h,Rm:()=>d,Im:()=>f,Rq:()=>u}),s(12115);var r=s(95155),i=s(53959),a=s(64976),n=s(52795),o=s(64183);let c={classic_board:function(e){let t,s,a,{className:n,onClick:o,size:c="small"}=e;return"large"===c?(t="w-80 h-96",s="w-64 h-64",a="text-xl"):"medium"===c?(t="w-64 h-80",s="w-48 h-48",a="text-lg"):(t="w-48 h-64",s="w-32 h-32",a="text-md"),(0,r.jsx)(i.Card,{className:"".concat(t," cursor-pointer ").concat(n),onClick:o,children:(0,r.jsxs)(i.CardContent,{className:"p-4 flex flex-col items-center justify-center h-full",children:[(0,r.jsx)("div",{className:"".concat(s," grid grid-cols-8 gap-0 border border-gray-300 rounded-sm overflow-hidden"),children:Array.from({length:64},(e,t)=>{let s=Math.floor(t/8),i=t%8;return(0,r.jsx)("div",{className:"aspect-square",style:{backgroundColor:(s+i)%2==0?"#ECCCA9":"#BD9375"}},t)})}),(0,r.jsx)("h3",{className:"".concat(a," font-semibold text-center mt-2"),children:"Классика"})]})})},badma_board:function(e){let t,s,a,{className:n,onClick:o,size:c="small"}=e;return"large"===c?(t="w-80 h-96",s="w-64 h-64",a="text-xl"):"medium"===c?(t="w-64 h-80",s="w-48 h-48",a="text-lg"):(t="w-48 h-64",s="w-32 h-32",a="text-md"),(0,r.jsx)(i.Card,{className:"".concat(t," cursor-pointer ").concat(n),onClick:o,children:(0,r.jsxs)(i.CardContent,{className:"p-4 flex flex-col items-center justify-center h-full",children:[(0,r.jsx)("div",{className:"".concat(s," grid grid-cols-8 gap-0 border border-gray-300 rounded-sm overflow-hidden"),children:Array.from({length:64},(e,t)=>{let s=Math.floor(t/8),i=t%8;return(0,r.jsx)("div",{className:"aspect-square",style:{backgroundColor:(s+i)%2==0?"#e8d0ff":"#c084fc"}},t)})}),(0,r.jsxs)("h3",{className:"".concat(a," font-semibold text-center"),children:["Ом Мани",(0,r.jsx)("br",{}),"Бадма Борд"]})]})})},classic_pieces:function(e){let t,s,n,o,{className:c,onClick:d,size:h="small"}=e;return"large"===h?(t="w-80 h-96",s="text-xl",n=60,o=48):"medium"===h?(t="w-64 h-80",s="text-lg",n=50,o=40):(t="w-48 h-64",s="text-md",n=40,o=32),(0,r.jsx)(i.Card,{className:"".concat(t," cursor-pointer ").concat(c),onClick:d,children:(0,r.jsxs)(i.CardContent,{className:"p-4 flex flex-col items-center justify-center h-full",children:[(0,r.jsxs)("div",{className:"flex items-center justify-center space-x-2 my-6",children:[(0,r.jsx)("div",{className:"transform -rotate-12 opacity-80 scale-200 relative right-2",style:{transform:"rotate(-12deg) scale(0.8)"},children:(0,r.jsx)(a.yc,{color:"#ffffff",size:o})}),(0,r.jsx)("div",{className:"z-10 scale-240",children:(0,r.jsx)(a.Wt,{color:"#ffffff",size:n})}),(0,r.jsx)("div",{className:"transform rotate-12 opacity-80 scale-200 relative left-2",style:{transform:"rotate(12deg) scale(0.8)"},children:(0,r.jsx)(a.WK,{color:"#ffffff",size:o})})]}),(0,r.jsx)("h3",{className:"".concat(s," font-semibold mt-3 text-center"),children:"Классика"})]})})},badma_pieces:function(e){let t,s,a,o,{className:c,onClick:d,size:h="small"}=e;return"large"===h?(t="w-80 h-96",s="text-xl",a=60,o=48):"medium"===h?(t="w-64 h-80",s="text-lg",a=50,o=40):(t="w-48 h-64",s="text-md",a=40,o=32),(0,r.jsx)(i.Card,{className:"".concat(t," cursor-pointer ").concat(c),onClick:d,children:(0,r.jsxs)(i.CardContent,{className:"pt-4 flex flex-col items-center justify-center h-full",children:[(0,r.jsxs)("div",{className:"flex items-center justify-center space-x-2 my-4",children:[(0,r.jsx)("div",{className:"transform -rotate-12 opacity-70 scale-200 relative right-2",style:{transform:"rotate(-12deg) scale(0.8)"},children:(0,r.jsx)(n.yc,{color:"#c084fc",size:o})}),(0,r.jsx)("div",{className:"z-10 scale-240",children:(0,r.jsx)(n.Wt,{color:"#c084fc",size:a})}),(0,r.jsx)("div",{className:"transform rotate-12 opacity-70 scale-200 relative left-2",style:{transform:"rotate(12deg) scale(0.8)"},children:(0,r.jsx)(n.WK,{color:"#c084fc",size:o})})]}),(0,r.jsxs)("h3",{className:"".concat(s," font-semibold mt-3 text-center"),children:["Ом Мани",(0,r.jsx)("br",{}),"Бадма Чесс"]})]})})},minefield_perk:o.Ay},d=[{id:"classic_pieces",name:"Классические фигуры",description:"Набор шахмат без стилизации",colors:{white:"#ffffff",black:"#000000"},category:"pieces",ItemComponent:c.classic_pieces},{id:"badma_pieces",name:"Фигуры Бадма",description:"Набор шахмат в стиле проекта Бадма, благодарность за участие в Альфа тесте",colors:{white:"#ffffff",black:"#000000"},category:"pieces",ItemComponent:c.badma_pieces}],h=[{id:"minefield_perk",name:"Минное поле",description:"Расставляет 4 случайные мины на пустых клетках доски. При попадании фигуры на мину она уничтожается.",perkClass:o.Qy,EffectComponent:o.LK,category:"perk",ItemComponent:c.minefield_perk}],l=[{id:"classic_board",name:"Классическая",description:"Стандартные цвета шахматной доски",lightColor:"#ECCCA9",darkColor:"#BD9375",category:"board",ItemComponent:c.classic_board},{id:"badma_board",name:"Бадма",description:"Фиолетовая тема в стиле проекта",lightColor:"#e8d0ff",darkColor:"#c084fc",category:"board",ItemComponent:c.badma_board}];function u(e){return d.find(t=>t.id===e)}let f=[...l.map(e=>({...e,category:"board"})),...d.map(e=>({...e,category:"pieces"})),...h.map(e=>({...e,category:"perk"}))]},76427:(e,t,s)=>{s.d(t,{ZC:()=>a,a$:()=>r,h_:()=>i});let r={board:"classic",pieces:"classic"};function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t={...r};return e.forEach(e=>{t[e.key]=e.value}),t}async function a(e,t,s){if(!e.userId)throw Error("User not authenticated");console.log("\uD83D\uDD27 [SET_SETTING] Setting ".concat(t," = ").concat(s," for user ").concat(e.userId));try{await e.delete({table:"badma_settings",where:{user_id:{_eq:e.userId},key:{_eq:t}}}),console.log("\uD83D\uDDD1️ [SET_SETTING] Deleted existing ".concat(t," settings")),await e.insert({table:"badma_settings",object:{user_id:e.userId,key:t,value:s}}),console.log("✅ [SET_SETTING] Created new ".concat(t," setting with value ").concat(s))}catch(e){throw console.error("❌ [SET_SETTING] Error setting ".concat(t,":"),e),e}}},97418:(e,t,s)=>{let r;s.d(t,{d:()=>c});var i=s(6781),a=s.n(i),n=s(13853);let o=(0,n.A)("chess");try{let e=i.Chess||a()||i;if(o("\uD83D\uDCE6 Chess imported as: ".concat(typeof e)),"function"!=typeof e){o("⚠️ Chess imported, but is not a function, creating wrapper");let t=function(s){if(!(this instanceof t))return new t(s);try{if("function"==typeof e)return e(s);if(e.Chess&&"function"==typeof e.Chess)return new e.Chess(s);if(e.default&&"function"==typeof e.default)return new e.default(s);else throw Error("Failed to create Chess instance")}catch(e){throw o("❌ Error creating chess engine: ".concat(e instanceof Error?e.stack||e.message:e)),e}};r=t}else r=e;try{let e=new r;o("✅ Test instance created successfully: ".concat(typeof e))}catch(e){o("❌ Failed to create test instance: ".concat(e instanceof Error?e.stack||e.message:e))}}catch(e){throw o("❌ Critical error importing chess: ".concat(e instanceof Error?e.stack||e.message:e)),Error("Cannot import chess: ".concat(e instanceof Error?e.message:String(e)))}o("✅ Chess successfully imported: ".concat(typeof r));class c{reset(){this._chess=new r,o("\uD83D\uDD04 Reset chess state to initial position")}get chess(){return this._chess}set chess(e){this._chess=e}get turn(){return"w"===this._chess.turn()?1:2}set turn(e){let t=c.normalizeSide(e),s=this._chess.fen().split(" ");s[1]=1===t?"w":"b",this._chess.load(s.join(" "))}get fen(){return o("get fen ".concat(this._chess.fen())),this._chess.fen()}set fen(e){o("set fen = ".concat(e)),this._chess.load(e)}static normalizeSide(e){return"w"===e||"white"===e||1===e?1:2}static sideToLetter(e){return 1===e?"w":"b"}moves(e){if(!Array.isArray(e)||0===e.length)return{success:!0,error:""};for(let t of(o("\uD83D\uDCE5 Applying ".concat(e.length," moves to the current position")),e)){let e=this.move(t);if(!e.success)return e}return{success:!0,error:""}}get status(){return this.isGameOver?this.isCheckmate?"checkmate":this.isStalemate?"stalemate":this.isDraw?"draw":"unknown":"continue"}getGameEndReason(){return this.status}get isGameOver(){if(!this._chess)return!1;try{return this._chess.game_over()||this.isStalemate||this.isCheckmate||this.isDraw}catch(e){return o("❌ Error checking game over: ".concat(e instanceof Error?e.message:String(e))),!1}}get isCheckmate(){if(!this._chess)return!1;try{return this._chess.in_checkmate()}catch(e){return o("❌ Error checking checkmate: ".concat(e instanceof Error?e.message:String(e))),!1}}get isStalemate(){if(!this._chess)return!1;try{return this._chess.in_stalemate()}catch(e){return o("❌ Error checking stalemate: ".concat(e instanceof Error?e.message:String(e))),!1}}get isDraw(){if(!this._chess)return!1;try{return this._chess.in_draw()}catch(e){return o("❌ Error checking draw: ".concat(e instanceof Error?e.message:String(e))),!1}}load(e){try{return this._chess.load(e)}catch(e){return o("❌ Error loading position: ".concat(e instanceof Error?e.message:String(e))),!1}}isSquareAttacked(e,t){let s=(0,n.A)("chess:attack"),r=[],i=e.charCodeAt(0)-97,a=parseInt(e[1])-1;if(i<0||i>=8||a<0||a>=8)return s("\uD83D\uDEA8 Invalid target square: ".concat(e)),!1;let o=c.sideToLetter(t);s(">>> Checking if square ".concat(e," (").concat(i,",").concat(a,") is attacked by ").concat(o));let d=this._chess.get(e);if(d&&d.color===o)return s("\uD83D\uDEE1️ Target square ".concat(e," contains a friendly piece ").concat(d.type).concat(d.color,", cannot be attacked by ").concat(o)),!1;s("\uD83D\uDD0D Iterating through all squares to find potential attackers...");for(let t=0;t<8;t++)for(let n=0;n<8;n++){let c=String.fromCharCode(97+t)+(n+1),d=this._chess.get(c);if(d&&d.color===o)switch(s("   \uD83E\uDDD0 Found potential attacker: ".concat(d.type).concat(d.color," at ").concat(c," (").concat(t,",").concat(n,")")),d.type){case"p":n+("w"===o?1:-1)===a&&(t+1===i||t-1===i)&&(s("      ⚔️ Pawn attack detected from ".concat(c," to ").concat(e,"!")),r.push({piece:d,from:c}));break;case"n":for(let[o,h]of[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]])if(t+o===i&&n+h===a){s("      ⚔️ Knight attack detected from ".concat(c," to ").concat(e,"!")),r.push({piece:d,from:c});break}break;case"k":for(let[o,h]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]])if(t+o===i&&n+h===a){s("      ⚔️ King attack detected from ".concat(c," to ").concat(e,"!")),r.push({piece:d,from:c});break}break;case"r":case"b":case"q":s("      \uD83C\uDFAF Checking sliding piece ".concat(d.type).concat(d.color," from ").concat(c));let h="r"===d.type||"q"===d.type,l="b"===d.type||"q"===d.type,u=[];for(let[o,f]of(h&&u.push([0,1],[0,-1],[1,0],[-1,0]),l&&u.push([1,1],[1,-1],[-1,1],[-1,-1]),u)){s("         ↗️ Checking line from ".concat(c," in direction (").concat(o,",").concat(f,") towards ").concat(e));let h=t+o,l=n+f;for(;h>=0&&h<8&&l>=0&&l<8;){let t=String.fromCharCode(97+h)+(l+1),n=h===i&&l===a;s("            ➡️ Checking intermediate square ".concat(t," (Target? ").concat(n,")"));let u=this._chess.get(t);if(s("            ♟️ Piece at ".concat(t,": ").concat(u?u.type+u.color:"null")),n){s("            ⚔️ ".concat(d.type.toUpperCase()," attack detected from ").concat(c," to ").concat(e," along direction (").concat(o,",").concat(f,")!")),r.push({piece:d,from:c});break}if(u){s("            \uD83D\uDEAB Path blocked by intermediate piece ".concat(u.type).concat(u.color," at ").concat(t));break}h+=o,l+=f}}}}return r.length>0?(s("<<< ✅ Square ".concat(e," is attacked by ").concat(o,". Attackers: ").concat(JSON.stringify(r))),!0):(s("<<< ❌ Square ".concat(e," is NOT attacked by ").concat(o)),!1)}_isMatchingSide(e,t){return"w"===e&&1===t||"b"===e&&2===t}debugSquare(e){(0,n.A)("chess:debug");let t=e.charCodeAt(0)-97,s=parseInt(e[1])-1,r=this._chess.get(e),i=this.isSquareAttacked(e,1),a=this.isSquareAttacked(e,2),o={};for(let[e,r]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]){let i=t+e,a=s+r;if(i>=0&&i<8&&a>=0&&a<8){let e=String.fromCharCode(97+i)+(a+1),t=this._chess.get(e);t&&(o[e]=t)}}for(let e of[{file:t-2,rank:s-1},{file:t-2,rank:s+1},{file:t-1,rank:s-2},{file:t-1,rank:s+2},{file:t+1,rank:s-2},{file:t+1,rank:s+2},{file:t+2,rank:s-1},{file:t+2,rank:s+1}])if(e.file>=0&&e.file<8&&e.rank>=0&&e.rank<8){let t=String.fromCharCode(97+e.file)+(e.rank+1),s=this._chess.get(t);s&&(o[t]=s)}return{square:e,piece:r,attackedByWhite:i,attackedByBlack:a,surroundingSquares:o,fenPosition:this.fen}}isKingInCheck(e){let t=(0,n.A)("chess:check"),s=c.sideToLetter(e),r=null;for(let e=0;e<8;e++){for(let t=0;t<8;t++){let i=String.fromCharCode(97+e)+(t+1),a=this._chess.get(i);if(a&&"k"===a.type&&a.color===s){r=i;break}}if(r)break}if(!r)return t("Could not find ".concat(1===e?"white":"black"," king on the board")),!1;let i=this.isSquareAttacked(r,1===e?2:1);return t("".concat(1===e?"White":"Black"," king at ").concat(r," is ").concat(i?"":"not ","in check")),i}isCastlingPathSafe(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.turn,s=1===t?2:1,r=1===t?"1":"8",i=(0,n.A)("chess:castling"),a="e".concat(r);if(e){let e=this.isSquareAttacked(a,s),n=this.isSquareAttacked("f".concat(r),s),o=this.isSquareAttacked("g".concat(r),s);return i("Kingside castling path check for ".concat(1===t?"white":"black",": ")),i("- e".concat(r," attacked by ").concat(1===s?"white":"black",": ").concat(e)),i("- f".concat(r," attacked by ").concat(1===s?"white":"black",": ").concat(n)),i("- g".concat(r," attacked by ").concat(1===s?"white":"black",": ").concat(o)),!e&&!n&&!o}{let e=this.isSquareAttacked(a,s),n=this.isSquareAttacked("d".concat(r),s),o=this.isSquareAttacked("c".concat(r),s);return i("Queenside castling path check for ".concat(1===t?"white":"black",": ")),i("- e".concat(r," attacked by ").concat(1===s?"white":"black",": ").concat(e)),i("- d".concat(r," attacked by ").concat(1===s?"white":"black",": ").concat(n)),i("- c".concat(r," attacked by ").concat(1===s?"white":"black",": ").concat(o)),!e&&!n&&!o}}isCastlingPathClear(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.turn,s=1===t?"1":"8";return(e?["f".concat(s),"g".concat(s)]:["b".concat(s),"c".concat(s),"d".concat(s)]).every(e=>null===this._chess.get(e))}hasCastlingRights(e,t){return this._chess.fen().split(" ")[2].includes(t?1===e?"K":"k":1===e?"Q":"q")}isCastlingLegal(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.turn;return this.isKingInCheck(t)?{legal:!1,reason:"King is in check"}:this.hasCastlingRights(t,e)?this.isCastlingPathClear(e,t)?this.isCastlingPathSafe(e,t)?{legal:!0}:{legal:!1,reason:"King passes through or lands on attacked square"}:{legal:!1,reason:"Path not clear"}:{legal:!1,reason:"No castling rights"}}canCastleKingside(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.turn;return!this.isKingInCheck(e)&&this.hasCastlingRights(e,!0)&&this.isCastlingPathClear(!0,e)&&this.isCastlingPathSafe(!0,e)}canCastleQueenside(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.turn;return!this.isKingInCheck(e)&&this.hasCastlingRights(e,!1)&&this.isCastlingPathClear(!1,e)&&this.isCastlingPathSafe(!1,e)}isCastlingMove(e){return"e1"===e.from&&("g1"===e.to||"c1"===e.to)||"e8"===e.from&&("g8"===e.to||"c8"===e.to)}move(e){if(!e.from||!e.to)return o("❌ Invalid move: missing 'from' or 'to'"),{success:!1,error:"Move must include 'from' and 'to' positions"};if(e.from=e.from.toLowerCase(),e.to=e.to.toLowerCase(),this.isGameOver){let e=this.status;return o("❌ Game is already over: ".concat(e)),{success:!1,error:"Game is already over: ".concat(e)}}let t=this.turn,s=this._chess.get(e.from);if(!s)return o("❌ Invalid move: no piece found at ".concat(e.from)),{success:!1,error:"Invalid move: No piece at ".concat(e.from)};let r=c.normalizeSide(s.color);if(r!==t)return o("❌ Wrong side to move: expected ".concat(t,", got ").concat(r," (piece at ").concat(e.from,")")),{success:!1,error:"It's ".concat(1===t?"white":"black","'s turn to move, not ").concat(1===r?"white":"black","'s (tried to move ").concat(s.color).concat(s.type," from ").concat(e.from,")")};let i=null;if(this.isCastlingMove(e)){let t="g1"===e.to||"g8"===e.to;o("\uD83C\uDFF0 Castling move detected: ".concat(t?"kingside":"queenside"," for ").concat(1===r?"white":"black")),o("\uD83D\uDEE1️ Strict FIDE castling validation always enabled");let s=this.isCastlingLegal(t,r);s.legal?o("✅ Strict FIDE castling validation passed PRE-MOVE check"):(o("❌ Castling not allowed PRE-MOVE check: ".concat(s.reason)),i="Castling not allowed: ".concat(s.reason))}if(i)return{success:!1,error:i};o("\uD83C\uDFB2 Attempting move in chess: ".concat(e.from," -> ").concat(e.to));let a={from:e.from,to:e.to};e.promotion&&(a.promotion=e.promotion);try{if(this._chess.move(a))return o("✅ Move executed successfully by chess: ".concat(e.from," -> ").concat(e.to,".")),o("\uD83C\uDFC1 Final FEN after move: ".concat(this.fen)),{success:!0,error:""};{o("❌ Invalid move reported by chess: ".concat(e.from," -> ").concat(e.to));let t="Invalid move: ".concat(e.from," -> ").concat(e.to,". Move rejected by underlying chess engine.");return this.isGameOver&&(t="Game is already over: ".concat(this.status),o("❌ Game over detected after invalid move by chess: ".concat(this.status))),{success:!1,error:t}}}catch(t){let e=t instanceof Error?t.message:String(t);return o("❌ Error executing move via chess: ".concat(e)),{success:!1,error:"Move execution error: ".concat(e)}}}put(e,t){try{let s=this._chess.put(e,t);return s?o("\uD83D\uDCE5 Piece ".concat(e.color).concat(e.type," placed on ").concat(t)):o("⚠️ Failed to place piece ".concat(e.color).concat(e.type," on ").concat(t)),s}catch(e){return o("❌ Error placing piece: ".concat(e instanceof Error?e.message:String(e))),!1}}remove(e){try{let t=this._chess.remove(e);if(t)return o("\uD83D\uDDD1️ Piece ".concat(t.color).concat(t.type," removed from ").concat(e)),{type:t.type,color:t.color};return o("\uD83E\uDD37 No piece found to remove at ".concat(e)),null}catch(e){return o("❌ Error removing piece: ".concat(e instanceof Error?e.message:String(e))),null}}constructor(e={}){this._config={...e},this.reset(),o("\uD83C\uDFAE Initial state: FEN = ".concat(this._chess.fen()))}}}}]);